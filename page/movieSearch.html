<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>搜索</title>
    <link rel="stylesheet" href="http://at.alicdn.com/t/font_1076111_gfum1llshv.css">
    <link rel="stylesheet" href="../css/common/reset.css">
    <link rel="stylesheet" href="../css/common/header.css">
    <link rel="stylesheet" href="../css/movieList.css">
    <script src="../js/jquery-1.9.1.min.js"></script>
    <script src="../js/font.js"></script>
</head>
<body>
<header class="header text-center">
    <a href="javascript:history.go(-1)" class="iconfont iconfanhui"></a>搜索
</header>
<div class="search-ipt">
    <i class="iconfont iconsousuo"></i>
    <input type="text" id="movieName"/>
    <button type="button" class="handIpt search-button pull-right" onclick="loadMovie(0,20,true)">搜索</button>
</div>
<div class="h-09"></div>
<div class="main search-main" id="list"></div>
<script>
    var num = null;
    function loadMovie(start,count,is) {
        var movie_name = $("#movieName").val(); //  要搜索的电影关键字
        if (movie_name) {
            if(is){
                var str = '';
                str += '<div class="loading">' +
                    '<img src="../img/loading.gif">' +
                    '</div>';
                $("#list").html(str);
            }
            var start = start; //   数据的开始项
            var count = count; //   请求的条数
            $.ajax({
                type: 'get',
                url: 'https://api.douban.com/v2/movie/search?q=' + movie_name + '&start=' + start + '&count=' + count,
                dataType: 'jsonp',
                success: function (data) {
                    var list = data.subjects;  //电影列表
                    // 使用is判断是加载更多电影还是搜索电影
                    if(!is){
                        if (list.length == "") {
                            $("#list").html("没有搜索到，换个关键词吧");
                        }
                    }
                    // 如果电影列表不为空进入循环
                    if (list != "") {
                        for (var i = 0; i < list.length; i++) {
                            var htm ='';
                                htm += '<div class="movie-item clearfix" onclick="movieDetail(' + list[i].id + ')">' +
                                '<div class="item-img pull-left">' +
                                '<img src="' + list[i].images.large + '" alt="" onerror="javascript:this.src=\'../img/loading.gif\';">' +
                                '</div>' +
                                '<div class="item-synopsis">' +
                                '<div class="item-title">' + list[i].title + '</div>' +
                                '<div class="item-graded">';
                            var stars = list[i].rating.stars.substring(0,1);
                            for (var star = 0; star < 5; star++) {
                                if (star < stars) {
                                    htm += '<span class="rating-star rating-star-medium-full"></span>';
                                } else {
                                    htm += '<span class="rating-star rating-star-medium-gray"></span>';
                                }
                            }
                            htm += list[i].rating.average +
                                '</div>' +
                                '<div class="item-figure">导演：';
                            for (var d = 0; d < list[i].directors.length; d++) {
                                htm += '<span>' + list[i].directors[d].name + '</span>';
                            }
                            htm += '</div>' +
                                '<div class="item-figure">演员：';
                            for (var j = 0; j < list[i].casts.length; j++) {
                                htm += '<span>' + list[i].casts[j].name + '</span>';
                            }
                            htm += '</div>' +
                                '<div class="item-figure">类型：';
                            for (var l = 0; l < list[i].genres.length; l++) {
                                htm += '<span>' + list[i].genres[l] + '</span>、';
                            }
                            htm += '</div>' +
                                '</div>' +
                                '</div>';
                            $("#list").append(htm);
                        }
                        $(".loading").remove();
                        num += list.length;
                    }else {
                        console.log("没有更多数据了");
                    }
                }
            })
        }
    }
    // 页面滚动到底部时加载更多
    $(window).scroll(function () {
        var scrollTop = $(this).scrollTop();
        var scrollHeight = $(document).height();
        var windowHeight = $(this).height();
        if (Math.ceil(scrollTop + windowHeight) == scrollHeight) {
            loadMovie(num,20,false);
        }
    });


    $(function () {
        // 回车事件 调用搜索按钮单击事件
        $(document).keydown(function (event) {
            if (event.keyCode == 13) {
                loadMovie(num,20,true);
            }
        });
        // 获取焦点时显示搜索按钮 失去时隐藏
        $("#movieName").focus(function () {
            $(this).css("width", "83%");
            $(".handIpt").css("margin", "0");
        }).blur(function () {
            $(this).css("width", "100%");
            $(".handIpt").css("margin-right", "-1.5rem");
        });
    });

    function movieDetail (id) {
        window.location.href='movieDetails.html?id=' + id
    }
</script>
</body>
</html>